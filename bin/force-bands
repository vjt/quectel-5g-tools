#!/usr/bin/env lua
-- force-bands: Lock Quectel modem to specific bands from UCI config

package.path = "/usr/lib/lua/?.lua;/usr/lib/lua/?/init.lua;" .. package.path

local quectel = require("quectel")
local posix_time = require("posix.time")

local function sleep(seconds)
    local sec = math.floor(seconds)
    local nsec = math.floor((seconds - sec) * 1e9)
    posix_time.nanosleep({tv_sec = sec, tv_nsec = nsec})
end

local function print_usage()
    print("Usage: force-bands [OPTION]")
    print("")
    print("Lock Quectel modem to bands configured in UCI.")
    print("")
    print("Options:")
    print("  --apply       Apply band configuration from UCI and display status")
    print("  --print       Display current band configuration")
    print("  --reset       Reset to all bands")
    print("  --wait=SECS   Wait SECS seconds before applying (use with --apply)")
    print("  --help        Show this help")
    print("")
    print("UCI configuration (in /etc/config/quectel):")
    print("  config modem 'modem'")
    print("    list lte_bands '1'")
    print("    list lte_bands '3'")
    print("    list lte_bands '7'")
    print("    list nr5g_bands '78'")
end

local function print_status(modem)
    print("Current band configuration:")
    print("")

    local mode = modem:get_band_config("mode_pref")
    print(string.format("  Mode: %s", mode or "?"))

    local lte = modem:get_band_config("lte_band")
    if type(lte) == "table" then
        print(string.format("  LTE bands: %s", table.concat(lte, ":")))
    else
        print(string.format("  LTE bands: %s", lte or "?"))
    end

    local nr = modem:get_band_config("nsa_nr5g_band")
    if type(nr) == "table" then
        print(string.format("  NR5G bands: %s", table.concat(nr, ":")))
    else
        print(string.format("  NR5G bands: %s", nr or "?"))
    end
end

-- Parse arguments
local action = nil
local wait_seconds = 0

for i = 1, #arg do
    local a = arg[i]
    if a == "--apply" then
        action = "apply"
    elseif a == "--print" then
        action = "print"
    elseif a == "--reset" then
        action = "reset"
    elseif a:match("^--wait=") then
        wait_seconds = tonumber(a:match("^--wait=(%d+)")) or 0
    elseif a == "--help" or a == "-h" then
        print_usage()
        os.exit(0)
    else
        io.stderr:write("Unknown option: " .. a .. "\n")
        print_usage()
        os.exit(1)
    end
end

-- No action = show help
if not action then
    print_usage()
    os.exit(0)
end

-- Connect to modem
local modem = quectel.create_modem()
local ok, err = modem:open()
if not ok then
    io.stderr:write("Error: " .. tostring(err) .. "\n")
    os.exit(1)
end

if action == "print" then
    print_status(modem)
    modem:close()
    os.exit(0)
end

if action == "reset" then
    print("Resetting to all bands...")

    local resp = modem:send('AT+QNWPREFCFG="lte_band"')
    if resp and resp:match("OK") then
        print("  LTE bands: reset to all")
    else
        io.stderr:write("  Failed to reset LTE bands\n")
    end

    resp = modem:send('AT+QNWPREFCFG="nsa_nr5g_band"')
    if resp and resp:match("OK") then
        print("  NR5G bands: reset to all")
    else
        io.stderr:write("  Failed to reset NR5G bands\n")
    end

    print("")
    print_status(modem)
    modem:close()
    os.exit(0)
end

if action == "apply" then
    -- Wait if requested
    if wait_seconds > 0 then
        print(string.format("Waiting for %d seconds...", wait_seconds))
        sleep(wait_seconds)
    end

    local config = quectel.load_config()

    if not config.lte_bands and not config.nr5g_bands then
        print("No band configuration found in UCI.")
        print("Configure with: uci add_list quectel.modem.lte_bands='1'")
        print("                uci add_list quectel.modem.lte_bands='3'")
        print("                uci add_list quectel.modem.nr5g_bands='78'")
        print("                uci commit quectel")
        print("")
        print_status(modem)
        modem:close()
        os.exit(1)
    end

    print("Applying band configuration from UCI...")
    print("")

    if config.lte_bands then
        local band_str = table.concat(config.lte_bands, ":")
        print(string.format("  LTE bands: %s", band_str))

        local resp = modem:send('AT+QNWPREFCFG="lte_band",' .. band_str)
        if resp and resp:match("OK") then
            print("    OK")
        else
            io.stderr:write("    Failed\n")
        end
    end

    if config.nr5g_bands then
        local band_str = table.concat(config.nr5g_bands, ":")
        print(string.format("  NR5G bands: %s", band_str))

        local resp = modem:send('AT+QNWPREFCFG="nsa_nr5g_band",' .. band_str)
        if resp and resp:match("OK") then
            print("    OK")
        else
            io.stderr:write("    Failed\n")
        end
    end

    print("")
    print_status(modem)
    modem:close()
    os.exit(0)
end
