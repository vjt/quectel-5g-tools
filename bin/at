#!/usr/bin/env lua
-- at: Simple AT command wrapper for Quectel modem

package.path = "/usr/lib/lua/?.lua;/usr/lib/lua/?/init.lua;" .. package.path

local quectel = require("quectel")

-- Default commands to run when called without arguments
local DEFAULT_COMMANDS = {
    "ATI",
    "AT+QSPN",
    'AT+QNWPREFCFG="mode_pref"',
    'AT+QNWPREFCFG="nsa_nr5g_band"',
    'AT+QNWPREFCFG="lte_band"',
    "AT+QCAINFO",
    'AT+QENG="servingcell"',
    'AT+QENG="neighbourcell"',
}

local function print_usage()
    print("Usage: at [COMMAND...]")
    print("")
    print("Send AT commands to the Quectel modem.")
    print("")
    print("If no command is specified, runs a default set of info commands.")
    print("")
    print("Examples:")
    print("  at ATI                    # Get modem info")
    print("  at 'AT+QENG=\"servingcell\"'  # Get serving cell")
    print("  at AT+CSQ AT+CREG?        # Multiple commands")
end

-- Parse arguments
local commands = {}
for i = 1, #arg do
    local a = arg[i]
    if a == "--help" or a == "-h" then
        print_usage()
        os.exit(0)
    else
        table.insert(commands, a)
    end
end

if #commands == 0 then
    commands = DEFAULT_COMMANDS
end

-- Connect to modem
local modem = quectel.create_modem()
local ok, err = modem:open()
if not ok then
    io.stderr:write("Error: " .. tostring(err) .. "\n")
    os.exit(1)
end

-- Send each command
for _, cmd in ipairs(commands) do
    print(cmd)
    local response, err = modem:send(cmd)
    if response then
        -- Print response, stripping echo if present
        for line in response:gmatch("[^\r\n]+") do
            if line ~= cmd then
                print(line)
            end
        end
    else
        io.stderr:write("Error: " .. tostring(err) .. "\n")
    end
    print("")
end

modem:close()
