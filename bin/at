#!/usr/bin/env python3
"""at: Simple AT command wrapper for Quectel modem."""

import sys

# Add src to path
sys.path.insert(0, "/usr/lib/python3")
sys.path.insert(0, str(__file__ and __import__("pathlib").Path(__file__).parent.parent / "src"))

from quectel.config import load_config
from quectel.modem import Modem, ModemError

# Default commands to run when called without arguments
DEFAULT_COMMANDS = [
    "ATI",
    "AT+QSPN",
    'AT+QNWPREFCFG="mode_pref"',
    'AT+QNWPREFCFG="nsa_nr5g_band"',
    'AT+QNWPREFCFG="lte_band"',
    "AT+QCAINFO",
    'AT+QENG="servingcell"',
    'AT+QENG="neighbourcell"',
]


def main():
    config = load_config()

    try:
        modem = Modem.from_config(config)
    except ModemError as e:
        print(f"Error: {e}", file=sys.stderr)
        print(f"Check that the modem is connected and {config.device} is correct.", file=sys.stderr)
        sys.exit(1)
    except Exception as e:
        print(f"Error: {e}", file=sys.stderr)
        sys.exit(1)

    if len(sys.argv) > 1:
        # Run specified command(s)
        commands = sys.argv[1:]
    else:
        # Run default commands
        commands = DEFAULT_COMMANDS

    for cmd in commands:
        print(f"\n{cmd}")
        print("-" * 40)
        response = modem.send_raw(cmd)
        print(response)
        print()


if __name__ == "__main__":
    main()
