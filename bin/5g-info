#!/usr/bin/env lua
-- 5g-info: CLI tool for displaying Quectel modem information

package.path = "/usr/lib/lua/?.lua;/usr/lib/lua/?/init.lua;" .. package.path

local quectel = require("quectel")
local display = quectel.display

local output_json = false
local section = "all"

local function print_usage()
    print("Usage: 5g-info [OPTIONS]")
    print("")
    print("Options:")
    print("  --json       Output as JSON")
    print("  --no-color   Disable colored output")
    print("  --section X  Show only section (device, network, serving, ca, neighbours)")
    print("  --help       Show this help")
end

-- Parse arguments
local i = 1
while i <= #arg do
    local a = arg[i]
    if a == "--json" then
        output_json = true
        display.set_color(false)
    elseif a == "--no-color" then
        display.set_color(false)
    elseif a == "--section" then
        i = i + 1
        section = arg[i] or "all"
    elseif a == "--help" or a == "-h" then
        print_usage()
        os.exit(0)
    end
    i = i + 1
end

-- Check if stdout is a TTY
local posix_ok, posix = pcall(require, "posix.unistd")
if posix_ok and posix.isatty then
    if not posix.isatty(1) then
        display.set_color(false)
    end
end

-- Connect to modem
local modem = quectel.create_modem()
local ok, status = pcall(function() return modem:get_status() end)

if not ok or not status then
    io.stderr:write("Error: Could not connect to modem\n")
    io.stderr:write("Check that the modem is connected and /dev/ttyUSB2 is accessible\n")
    os.exit(1)
end

if output_json then
    print(display.to_json(status))
    modem:close()
    os.exit(0)
end

-- Display requested sections
local sections
if section == "all" then
    sections = {"device", "network", "serving", "ca", "neighbours"}
else
    sections = {section}
end

for _, s in ipairs(sections) do
    if s == "device" then
        display.print_device_info(status)
    elseif s == "network" then
        display.print_network_info(status)
    elseif s == "serving" then
        display.print_serving_cell(status, false)
    elseif s == "ca" then
        display.print_carrier_aggregation(status, false)
    elseif s == "neighbours" then
        display.print_neighbours(status, nil)
    end
end

modem:close()
